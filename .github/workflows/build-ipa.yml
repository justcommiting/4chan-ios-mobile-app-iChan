name: Build iOS IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.3.10'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Install CocoaPods
      run: |
        cd ios
        pod install
        
    # Optional: Set up code signing if certificates are available
    # Uncomment and configure the following steps if you have Apple certificates
    # - name: Install Apple Certificate
    #   if: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
    #   uses: apple-actions/import-codesign-certs@v2
    #   with:
    #     p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
    #     p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
    #
    # - name: Install Provisioning Profile
    #   if: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 != '' }}
    #   run: |
    #     mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
    #     echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        
    - name: Build iOS (without codesigning)
      run: |
        flutter build ios --release --no-codesign
        
    - name: Create IPA manually
      run: |
        mkdir -p Payload
        cp -r build/ios/iphoneos/Runner.app Payload/
        zip -r iChan.ipa Payload
        rm -rf Payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v3
      with:
        name: iChan-IPA
        path: iChan.ipa
        retention-days: 30
        
    # Optional: Create a release with the IPA if this is a tag push
    # - name: Create Release
    #   if: startsWith(github.ref, 'refs/tags/')
    #   uses: softprops/action-gh-release@v1
    #   with:
    #     files: iChan.ipa
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
